#!/bin/bash
# Pre-deployment validation hook for {{ProjectName}}
# Generated by PKS CLI

echo "ğŸš€ Pre-deployment validation for {{ProjectName}}"

# Read JSON input
json_input=$(cat)
command=$(echo "$json_input" | jq -r '.command // empty')
environment=$(echo "$json_input" | jq -r '.environment // "production"')

echo "ğŸ¯ Target environment: $environment"

# Environment-specific validations
case "$environment" in
    "production"|"prod")
        echo "ğŸ”’ Running production deployment validations..."
        
        # Check for required environment variables
        required_vars=("CONNECTION_STRING" "API_KEY")
        for var in "${required_vars[@]}"; do
            if [ -z "${!var}" ]; then
                echo "âŒ Missing required environment variable: $var"
                exit 1
            fi
        done
        
        echo "âœ… Environment variables validated"
        ;;
    "staging"|"stage")
        echo "ğŸ”§ Running staging deployment validations..."
        ;;
    "development"|"dev")
        echo "ğŸ› ï¸  Running development deployment validations..."
        ;;
    *)
        echo "âš ï¸  Unknown environment: $environment"
        ;;
esac

# Check deployment prerequisites
echo "Checking deployment prerequisites..."

# Validate build artifacts exist
if [ -d "bin/Release" ] || [ -d "bin/Debug" ]; then
    echo "âœ… Build artifacts found"
else
    echo "âŒ Build artifacts not found - run build first"
    exit 1
fi

# Check for deployment configuration
deployment_configs=("appsettings.json" "Dockerfile" "deployment.yml" "helm")
config_found=false

for config in "${deployment_configs[@]}"; do
    if [ -f "$config" ] || [ -d "$config" ]; then
        echo "âœ… Deployment configuration found: $config"
        config_found=true
        break
    fi
done

if [ "$config_found" = false ]; then
    echo "âš ï¸  No deployment configuration found"
fi

# Optional: Run pre-deployment tests
echo "ğŸ§ª Running pre-deployment validations..."

echo "âœ… Pre-deployment validation completed for {{ProjectName}}"
exit 0