name: Semantic Release

on:
  push:
    branches:
      - main
      - vnext
      - develop
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      cli: ${{ steps.changes.outputs.cli }}
      devcontainer: ${{ steps.changes.outputs.devcontainer }}
      claude-dotnet-9: ${{ steps.changes.outputs.claude-dotnet-9 }}
      claude-dotnet-10-full: ${{ steps.changes.outputs.claude-dotnet-10-full }}
      pks-fullstack: ${{ steps.changes.outputs.pks-fullstack }}
      has-templates: ${{ steps.changes.outputs.has-templates }}
      template-matrix: ${{ steps.changes.outputs.template-matrix }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Make detect-changes.sh executable
      run: chmod +x scripts/detect-changes.sh

    - name: Detect changes
      id: changes
      run: |
        echo "Running change detection..."

        # Run the change detection script
        CHANGE_JSON=$(scripts/detect-changes.sh)

        echo "Change detection result: $CHANGE_JSON"

        # Parse JSON and set outputs for each package
        CLI_CHANGED=$(echo "$CHANGE_JSON" | jq -r '.cli')
        DEVCONTAINER_CHANGED=$(echo "$CHANGE_JSON" | jq -r '.devcontainer')
        CLAUDE_DOTNET_9_CHANGED=$(echo "$CHANGE_JSON" | jq -r '."claude-dotnet-9"')
        CLAUDE_DOTNET_10_FULL_CHANGED=$(echo "$CHANGE_JSON" | jq -r '."claude-dotnet-10-full"')
        PKS_FULLSTACK_CHANGED=$(echo "$CHANGE_JSON" | jq -r '."pks-fullstack"')

        echo "cli=$CLI_CHANGED" >> $GITHUB_OUTPUT
        echo "devcontainer=$DEVCONTAINER_CHANGED" >> $GITHUB_OUTPUT
        echo "claude-dotnet-9=$CLAUDE_DOTNET_9_CHANGED" >> $GITHUB_OUTPUT
        echo "claude-dotnet-10-full=$CLAUDE_DOTNET_10_FULL_CHANGED" >> $GITHUB_OUTPUT
        echo "pks-fullstack=$PKS_FULLSTACK_CHANGED" >> $GITHUB_OUTPUT

        # Check if any templates have changes
        HAS_TEMPLATES=false
        if [[ "$DEVCONTAINER_CHANGED" == "true" ]] || \
           [[ "$CLAUDE_DOTNET_9_CHANGED" == "true" ]] || \
           [[ "$CLAUDE_DOTNET_10_FULL_CHANGED" == "true" ]] || \
           [[ "$PKS_FULLSTACK_CHANGED" == "true" ]]; then
          HAS_TEMPLATES=true
        fi

        echo "has-templates=$HAS_TEMPLATES" >> $GITHUB_OUTPUT

        # Build matrix for templates that have changes
        MATRIX_JSON='{"include":['
        FIRST=true

        if [[ "$DEVCONTAINER_CHANGED" == "true" ]]; then
          MATRIX_JSON="${MATRIX_JSON}{\"template\":\"devcontainer\",\"template_path\":\"templates/devcontainer\",\"package_id\":\"PKS.Templates.DevContainer\",\"config_file\":\".releaserc.templates.devcontainer.json\"}"
          FIRST=false
        fi

        if [[ "$CLAUDE_DOTNET_9_CHANGED" == "true" ]]; then
          if [[ "$FIRST" == "false" ]]; then MATRIX_JSON="${MATRIX_JSON},"; fi
          MATRIX_JSON="${MATRIX_JSON}{\"template\":\"claude-dotnet-9\",\"template_path\":\"templates/claude-dotnet-9\",\"package_id\":\"PKS.Templates.ClaudeDotNet9\",\"config_file\":\".releaserc.templates.claude-dotnet-9.json\"}"
          FIRST=false
        fi

        if [[ "$CLAUDE_DOTNET_10_FULL_CHANGED" == "true" ]]; then
          if [[ "$FIRST" == "false" ]]; then MATRIX_JSON="${MATRIX_JSON},"; fi
          MATRIX_JSON="${MATRIX_JSON}{\"template\":\"claude-dotnet-10-full\",\"template_path\":\"templates/claude-dotnet-10-full\",\"package_id\":\"PKS.Templates.ClaudeDotNet10.Full\",\"config_file\":\".releaserc.templates.claude-dotnet-10-full.json\"}"
          FIRST=false
        fi

        if [[ "$PKS_FULLSTACK_CHANGED" == "true" ]]; then
          if [[ "$FIRST" == "false" ]]; then MATRIX_JSON="${MATRIX_JSON},"; fi
          MATRIX_JSON="${MATRIX_JSON}{\"template\":\"pks-fullstack\",\"template_path\":\"templates/pks-fullstack\",\"package_id\":\"PKS.Templates.PksFullstack\",\"config_file\":\".releaserc.templates.pks-fullstack.json\"}"
          FIRST=false
        fi

        MATRIX_JSON="${MATRIX_JSON}]}"

        echo "template-matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
        echo "Template matrix: $MATRIX_JSON"

    - name: Generate Detection Summary
      run: |
        echo "# ðŸ” Change Detection Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${GITHUB_REF#refs/heads/}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Package Changes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ steps.changes.outputs.cli }}" == "true" ]]; then
          echo "- âœ… **CLI**: Changes detected" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â­ï¸ **CLI**: No changes" >> $GITHUB_STEP_SUMMARY
        fi

        if [[ "${{ steps.changes.outputs.devcontainer }}" == "true" ]]; then
          echo "- âœ… **devcontainer**: Changes detected" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â­ï¸ **devcontainer**: No changes" >> $GITHUB_STEP_SUMMARY
        fi

        if [[ "${{ steps.changes.outputs.claude-dotnet-9 }}" == "true" ]]; then
          echo "- âœ… **claude-dotnet-9**: Changes detected" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â­ï¸ **claude-dotnet-9**: No changes" >> $GITHUB_STEP_SUMMARY
        fi

        if [[ "${{ steps.changes.outputs.claude-dotnet-10-full }}" == "true" ]]; then
          echo "- âœ… **claude-dotnet-10-full**: Changes detected" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â­ï¸ **claude-dotnet-10-full**: No changes" >> $GITHUB_STEP_SUMMARY
        fi

        if [[ "${{ steps.changes.outputs.pks-fullstack }}" == "true" ]]; then
          echo "- âœ… **pks-fullstack**: Changes detected" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â­ï¸ **pks-fullstack**: No changes" >> $GITHUB_STEP_SUMMARY
        fi

  release-cli:
    name: Release CLI
    needs: detect-changes
    if: needs.detect-changes.outputs.cli == 'true'
    uses: ./.github/workflows/release-cli.yml
    secrets: inherit

  release-templates:
    name: Release Templates
    needs: detect-changes
    if: needs.detect-changes.outputs.has-templates == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.template-matrix) }}
      fail-fast: false
    uses: ./.github/workflows/release-template.yml
    with:
      template: ${{ matrix.template }}
      template_path: ${{ matrix.template_path }}
      package_id: ${{ matrix.package_id }}
      config_file: ${{ matrix.config_file }}
    secrets: inherit

  summary:
    name: Release Summary
    needs: [detect-changes, release-cli, release-templates]
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate Comprehensive Summary
      run: |
        echo "# ðŸ“¦ Semantic Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${GITHUB_REF#refs/heads/}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Run Number:** \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Job status summary
        echo "## Job Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Change Detection | ${{ needs.detect-changes.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| CLI Release | ${{ needs.release-cli.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Template Releases | ${{ needs.release-templates.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Check what was released
        echo "## Releases Created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        RELEASES_CREATED=false

        # Check CLI release
        if [[ "${{ needs.detect-changes.outputs.cli }}" == "true" ]]; then
          CLI_TAG=$(git tag -l "v*" --sort=-version:refname | head -n 1 || echo "")
          if [[ -n "$CLI_TAG" ]]; then
            CLI_VERSION=${CLI_TAG#v}
            echo "### âœ… CLI - v$CLI_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Package:** \`pks-cli\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Version:** \`$CLI_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag:** \`$CLI_TAG\`" >> $GITHUB_STEP_SUMMARY
            echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/$CLI_TAG)" >> $GITHUB_STEP_SUMMARY
            echo "- [View on NuGet](https://www.nuget.org/packages/pks-cli/$CLI_VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            RELEASES_CREATED=true
          else
            echo "### âš ï¸ CLI" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Changes detected but no release created (no releasable commits)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        # Check template releases
        for TEMPLATE in devcontainer claude-dotnet-9 claude-dotnet-10-full pks-fullstack; do
          TEMPLATE_OUTPUT="TEMPLATE_${TEMPLATE//-/_}"
          TEMPLATE_CHANGED=$(echo "${{ needs.detect-changes.outputs.devcontainer }}" | jq -r '.["'$TEMPLATE'"] // "false"')

          if [[ "${{ needs.detect-changes.outputs[format('{0}', TEMPLATE)] }}" == "true" ]] 2>/dev/null || \
             [[ "${{ needs.detect-changes.outputs.devcontainer }}" == "true" && "$TEMPLATE" == "devcontainer" ]] || \
             [[ "${{ needs.detect-changes.outputs.claude-dotnet-9 }}" == "true" && "$TEMPLATE" == "claude-dotnet-9" ]] || \
             [[ "${{ needs.detect-changes.outputs.claude-dotnet-10-full }}" == "true" && "$TEMPLATE" == "claude-dotnet-10-full" ]] || \
             [[ "${{ needs.detect-changes.outputs.pks-fullstack }}" == "true" && "$TEMPLATE" == "pks-fullstack" ]]; then

            TEMPLATE_TAG=$(git tag -l "${TEMPLATE}-v*" --sort=-version:refname | head -n 1 || echo "")
            if [[ -n "$TEMPLATE_TAG" ]]; then
              TEMPLATE_VERSION=${TEMPLATE_TAG#${TEMPLATE}-v}

              # Map template name to package ID
              case "$TEMPLATE" in
                "devcontainer")
                  PACKAGE_ID="PKS.Templates.DevContainer"
                  ;;
                "claude-dotnet-9")
                  PACKAGE_ID="PKS.Templates.ClaudeDotNet9"
                  ;;
                "claude-dotnet-10-full")
                  PACKAGE_ID="PKS.Templates.ClaudeDotNet10.Full"
                  ;;
                "pks-fullstack")
                  PACKAGE_ID="PKS.Templates.PksFullstack"
                  ;;
              esac

              echo "### âœ… Template: $TEMPLATE - v$TEMPLATE_VERSION" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- **Package:** \`$PACKAGE_ID\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Version:** \`$TEMPLATE_VERSION\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Tag:** \`$TEMPLATE_TAG\`" >> $GITHUB_STEP_SUMMARY
              echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/$TEMPLATE_TAG)" >> $GITHUB_STEP_SUMMARY
              echo "- [View on NuGet](https://www.nuget.org/packages/$PACKAGE_ID/$TEMPLATE_VERSION)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              RELEASES_CREATED=true
            fi
          fi
        done

        if [[ "$RELEASES_CREATED" == "false" ]]; then
          echo "### â„¹ï¸ No Releases Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No new versions were released. This can happen when:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- No packages had changes since their last release" >> $GITHUB_STEP_SUMMARY
          echo "- Changes detected but no commits follow conventional commit format" >> $GITHUB_STEP_SUMMARY
          echo "- All commits use non-release types (\`chore:\`, \`docs:\`, \`style:\`)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Installation instructions
        if [[ "$RELEASES_CREATED" == "true" ]]; then
          echo "## ðŸ’» Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.detect-changes.outputs.cli }}" == "true" ]]; then
            CLI_TAG=$(git tag -l "v*" --sort=-version:refname | head -n 1 || echo "")
            if [[ -n "$CLI_TAG" ]]; then
              CLI_VERSION=${CLI_TAG#v}
              echo "### CLI Tool" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
              if [[ "$CLI_VERSION" == *"-rc."* ]] || [[ "$CLI_VERSION" == *"-dev."* ]]; then
                echo "dotnet tool install --global pks-cli --version $CLI_VERSION --prerelease" >> $GITHUB_STEP_SUMMARY
              else
                echo "dotnet tool install --global pks-cli --version $CLI_VERSION" >> $GITHUB_STEP_SUMMARY
              fi
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [[ "${{ needs.detect-changes.outputs.has-templates }}" == "true" ]]; then
            echo "### Templates" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY

            for TEMPLATE in devcontainer claude-dotnet-9 claude-dotnet-10-full pks-fullstack; do
              if [[ "${{ needs.detect-changes.outputs.devcontainer }}" == "true" && "$TEMPLATE" == "devcontainer" ]] || \
                 [[ "${{ needs.detect-changes.outputs.claude-dotnet-9 }}" == "true" && "$TEMPLATE" == "claude-dotnet-9" ]] || \
                 [[ "${{ needs.detect-changes.outputs.claude-dotnet-10-full }}" == "true" && "$TEMPLATE" == "claude-dotnet-10-full" ]] || \
                 [[ "${{ needs.detect-changes.outputs.pks-fullstack }}" == "true" && "$TEMPLATE" == "pks-fullstack" ]]; then

                TEMPLATE_TAG=$(git tag -l "${TEMPLATE}-v*" --sort=-version:refname | head -n 1 || echo "")
                if [[ -n "$TEMPLATE_TAG" ]]; then
                  TEMPLATE_VERSION=${TEMPLATE_TAG#${TEMPLATE}-v}

                  case "$TEMPLATE" in
                    "devcontainer")
                      PACKAGE_ID="PKS.Templates.DevContainer"
                      ;;
                    "claude-dotnet-9")
                      PACKAGE_ID="PKS.Templates.ClaudeDotNet9"
                      ;;
                    "claude-dotnet-10-full")
                      PACKAGE_ID="PKS.Templates.ClaudeDotNet10.Full"
                      ;;
                    "pks-fullstack")
                      PACKAGE_ID="PKS.Templates.PksFullstack"
                      ;;
                  esac

                  echo "# Install $TEMPLATE template" >> $GITHUB_STEP_SUMMARY
                  if [[ "$TEMPLATE_VERSION" == *"-rc."* ]] || [[ "$TEMPLATE_VERSION" == *"-dev."* ]]; then
                    echo "dotnet new install $PACKAGE_ID::$TEMPLATE_VERSION --force" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "dotnet new install $PACKAGE_ID::$TEMPLATE_VERSION" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done

            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        fi