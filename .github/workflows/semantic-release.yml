name: Semantic Release

on:
  push:
    branches:
      - main
      - vnext
      - develop
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          ~/.nuget/packages
        key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json', '**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-deps-
          
    - name: Install semantic-release
      run: |
        npm install -g \
          semantic-release \
          @semantic-release/changelog \
          @semantic-release/git \
          @semantic-release/github \
          @semantic-release/exec \
          conventional-changelog-conventionalcommits
          
    - name: Get current version and branch info
      id: current_version
      run: |
        # Extract version from main project file
        VERSION=$(grep -oP '(?<=<Version>)[^<]+' src/pks-cli.csproj || echo "0.0.0")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $VERSION"
        
        # Determine if this is a release branch
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "Current branch: $BRANCH_NAME"
        
        if [[ $BRANCH_NAME == release/* ]]; then
          # Extract target version from branch name (e.g., release/1.0.0 -> 1.0.0)
          TARGET_VERSION=${BRANCH_NAME#release/}
          echo "target_version=$TARGET_VERSION" >> $GITHUB_OUTPUT
          echo "Target version for pre-releases: $TARGET_VERSION"
          echo "is_release_branch=true" >> $GITHUB_OUTPUT
        else
          echo "is_release_branch=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Build and package .NET projects
      run: |
        echo "üî® Building .NET projects..."
        
        # Determine if this is a pre-release branch
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        if [[ $BRANCH_NAME == release/* ]]; then
          echo "üì¶ Pre-release branch detected: $BRANCH_NAME"
          # For pre-release, we'll set version after semantic-release determines it
          IS_PRERELEASE=true
        else
          echo "üöÄ Main branch detected: $BRANCH_NAME"
          IS_PRERELEASE=false
        fi
        
        # Build only the main CLI project and templates, skip tests for now
        dotnet restore src/pks-cli.csproj
        dotnet build src/pks-cli.csproj --configuration Release
        
        # Build and pack template projects
        find templates -name "*.csproj" -type f | while read -r template; do
          echo "Building template: $template"
          dotnet build "$template" --configuration Release
        done
        
        echo "Build completed, packages will be created after semantic-release determines version"
        
    - name: Run semantic-release
      id: semantic
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "üöÄ Running semantic release..."
        npx semantic-release
        
    - name: Create packages with correct version
      if: success()
      run: |
        # Get the latest tag (which semantic-release just created)
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -n "$LATEST_TAG" ]; then
          # Remove 'v' prefix to get the version
          VERSION=${LATEST_TAG#v}
          echo "üì¶ Creating packages with version: $VERSION"
          
          # Create packages directory
          mkdir -p packages
          
          # Pack CLI project with the correct version
          dotnet pack src/pks-cli.csproj \
            --configuration Release \
            --output ./packages \
            --no-build \
            -p:PackageVersion=$VERSION
            
          # Pack template projects with the correct version
          find templates -name "*.csproj" -type f | while read -r template; do
            echo "Packing template: $template with version $VERSION"
            dotnet pack "$template" \
              --configuration Release \
              --output ./packages \
              --no-build \
              -p:PackageVersion=$VERSION
          done
          
          echo "‚úÖ Packages created successfully with version $VERSION"
          ls -la packages/
        else
          echo "‚ùå No release tag found, skipping package creation"
        fi
        
    - name: Upload packages to release
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Check if any release was created by looking for tags
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -n "$LATEST_TAG" ] && [ -d "packages" ] && [ "$(ls -A packages/*.nupkg 2>/dev/null)" ]; then
          echo "üì¶ Uploading packages to release $LATEST_TAG"
          
          # Upload packages to the release
          for package in packages/*.nupkg; do
            if [ -f "$package" ]; then
              echo "Uploading $(basename $package) to release $LATEST_TAG"
              gh release upload "$LATEST_TAG" "$package" --clobber || echo "Failed to upload $package"
            fi
          done
        else
          echo "‚ÑπÔ∏è No release tag found or no packages to upload"
        fi
        
    - name: Publish to NuGet
      if: success()
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      run: |
        if [ -n "$NUGET_API_KEY" ] && [ -d "packages" ] && [ "$(ls -A packages/*.nupkg 2>/dev/null)" ]; then
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          
          if [[ $BRANCH_NAME == release/* ]]; then
            echo "üì¶ Publishing PRE-RELEASE packages to NuGet..."
          else
            echo "üì¶ Publishing RELEASE packages to NuGet..."
          fi
          
          for package in packages/*.nupkg; do
            if [ -f "$package" ]; then
              echo "Publishing $(basename $package)"
              dotnet nuget push "$package" --api-key "$NUGET_API_KEY" --source https://api.nuget.org/v3/index.json --skip-duplicate || echo "Failed to publish $package"
            fi
          done
        else
          echo "‚ö†Ô∏è NUGET_API_KEY not set or no packages found, skipping NuGet publish"
        fi

    - name: Generate Release Summary
      if: always()
      run: |
        echo "# üì¶ Semantic Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Get branch information
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        echo "**Branch:** \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Check if a release was created
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

        if [ -n "$LATEST_TAG" ]; then
          VERSION=${LATEST_TAG#v}

          # Determine release type
          if [[ $LATEST_TAG == *"-rc."* ]] || [[ $LATEST_TAG == *"-dev."* ]]; then
            RELEASE_TYPE="Pre-release"
            EMOJI="üî∂"
          else
            RELEASE_TYPE="Stable Release"
            EMOJI="‚úÖ"
          fi

          echo "## $EMOJI $RELEASE_TYPE Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Add release notes preview
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>üìù Release Notes Preview</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          git tag -l --format='%(contents)' "$LATEST_TAG" | head -n 20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List packages created
          if [ -d "packages" ] && [ "$(ls -A packages/*.nupkg 2>/dev/null)" ]; then
            echo "### üì¶ Packages Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for package in packages/*.nupkg; do
              if [ -f "$package" ]; then
                PACKAGE_NAME=$(basename "$package")
                PACKAGE_SIZE=$(ls -lh "$package" | awk '{print $5}')
                echo "- ‚úÖ \`$PACKAGE_NAME\` ($PACKAGE_SIZE)" >> $GITHUB_STEP_SUMMARY
              fi
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Add links
          echo "### üîó Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [View Release on GitHub](https://github.com/${{ github.repository }}/releases/tag/$LATEST_TAG)" >> $GITHUB_STEP_SUMMARY
          echo "- [View on NuGet.org](https://www.nuget.org/packages/pks-cli/$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [Compare Changes](https://github.com/${{ github.repository }}/compare/$LATEST_TAG)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Installation command
          echo "### üíª Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ $LATEST_TAG == *"-rc."* ]] || [[ $LATEST_TAG == *"-dev."* ]]; then
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "dotnet tool install --global pks-cli --version $VERSION --prerelease" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "dotnet tool install --global pks-cli --version $VERSION" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

          # Changelog status
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Changelog Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ $LATEST_TAG == *"-rc."* ]] || [[ $LATEST_TAG == *"-dev."* ]]; then
            echo "‚ÑπÔ∏è CHANGELOG.md was **not updated** for this pre-release" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The changelog will be updated when this is released as a stable version." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ CHANGELOG.md has been **updated** with this release" >> $GITHUB_STEP_SUMMARY
          fi

        else
          echo "## ‚ÑπÔ∏è No Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No new version was released. This can happen when:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- No commits since last release contain \`feat:\`, \`fix:\`, or breaking changes" >> $GITHUB_STEP_SUMMARY
          echo "- All commits use types that don't trigger releases (e.g., \`chore:\`, \`docs:\`, \`style:\`)" >> $GITHUB_STEP_SUMMARY
          echo "- Commit messages don't follow conventional commit format" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show recent commits
          echo "### Recent Commits" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          git log --oneline -5 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi