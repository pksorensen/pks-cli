name: Semantic Release

on:
  push:
    branches:
      - main
      - vnext
      - develop
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      cli: ${{ steps.changes.outputs.cli }}
      has-templates: ${{ steps.changes.outputs.has-templates }}
      template-matrix: ${{ steps.changes.outputs.template-matrix }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Make scripts executable
      run: |
        chmod +x scripts/detect-changes.sh
        chmod +x scripts/discover-templates.sh

    - name: Detect changes
      id: changes
      run: |
        echo "ðŸ” Running change detection..."

        # Run the change detection script (now with dynamic template discovery)
        CHANGE_JSON=$(scripts/detect-changes.sh)

        echo "ðŸ“Š Change detection result: $CHANGE_JSON"

        # Parse CLI changes
        CLI_CHANGED=$(echo "$CHANGE_JSON" | jq -r '.cli')
        echo "cli=$CLI_CHANGED" >> $GITHUB_OUTPUT

        # Discover all available templates
        echo "ðŸ”Ž Discovering template packages..."
        ALL_TEMPLATES=$(scripts/discover-templates.sh | jq -c '.')
        echo "ðŸ“¦ Available templates: $ALL_TEMPLATES"

        # Build matrix for templates that have changes
        echo "ðŸ—ï¸  Building release matrix..."
        MATRIX_JSON='{"include":[]}'

        # Extract changed templates and build matrix
        HAS_TEMPLATES=false
        for template_name in $(echo "$CHANGE_JSON" | jq -r 'to_entries[] | select(.key != "cli" and .value == true) | .key'); do
          HAS_TEMPLATES=true

          # Find template details from discovery
          TEMPLATE_DETAILS=$(echo "$ALL_TEMPLATES" | jq -c ".include[] | select(.template == \"$template_name\")")

          if [ -n "$TEMPLATE_DETAILS" ]; then
            # Add to matrix (use -c for compact output)
            MATRIX_JSON=$(echo "$MATRIX_JSON" | jq -c ".include += [$TEMPLATE_DETAILS]")
            echo "  âœ… Added $template_name to release matrix"
          fi
        done

        echo "has-templates=$HAS_TEMPLATES" >> $GITHUB_OUTPUT
        echo "template-matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
        echo "ðŸ“‹ Template matrix (compact): $MATRIX_JSON"

    - name: Generate Detection Summary
      run: |
        echo "# ðŸ” Change Detection Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${GITHUB_REF#refs/heads/}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Package Changes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Run detection again to get the results for display
        CHANGE_JSON=$(scripts/detect-changes.sh)

        # Display CLI status
        CLI_CHANGED=$(echo "$CHANGE_JSON" | jq -r '.cli')
        if [[ "$CLI_CHANGED" == "true" ]]; then
          echo "- âœ… **CLI**: Changes detected" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â­ï¸ **CLI**: No changes" >> $GITHUB_STEP_SUMMARY
        fi

        # Dynamically display template changes
        for package in $(echo "$CHANGE_JSON" | jq -r 'keys[]' | grep -v "^cli$"); do
          CHANGED=$(echo "$CHANGE_JSON" | jq -r ".[\"$package\"]")
          if [[ "$CHANGED" == "true" ]]; then
            echo "- âœ… **$package**: Changes detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ **$package**: No changes" >> $GITHUB_STEP_SUMMARY
          fi
        done

        # Add matrix preview if templates will be released
        if [[ "${{ steps.changes.outputs.has-templates }}" == "true" ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Templates to Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          MATRIX='${{ steps.changes.outputs.template-matrix }}'
          echo "$MATRIX" | jq -r '.include[] | "- **\(.template)** (\(.package_id))"' >> $GITHUB_STEP_SUMMARY
        fi

  release-cli:
    name: Release CLI
    needs: detect-changes
    if: needs.detect-changes.outputs.cli == 'true'
    uses: ./.github/workflows/release-cli.yml
    secrets: inherit

  release-npm:
    name: Release npm
    needs: detect-changes
    if: needs.detect-changes.outputs.cli == 'true'
    uses: ./.github/workflows/release-npm.yml
    secrets: inherit

  release-templates:
    name: Release Templates
    needs: detect-changes
    if: needs.detect-changes.outputs.has-templates == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.template-matrix) }}
      fail-fast: false
    uses: ./.github/workflows/release-template.yml
    with:
      template: ${{ matrix.template }}
      template_path: ${{ matrix.template_path }}
      package_id: ${{ matrix.package_id }}
      config_file: ${{ matrix.config_file }}
    secrets: inherit

  summary:
    name: Release Summary
    needs: [detect-changes, release-cli, release-npm, release-templates]
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate Comprehensive Summary
      run: |
        echo "# ðŸ“¦ Semantic Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${GITHUB_REF#refs/heads/}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow:** \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Run Number:** \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Job status summary
        echo "## Job Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Change Detection | ${{ needs.detect-changes.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| CLI Release (NuGet) | ${{ needs.release-cli.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| npm Release | ${{ needs.release-npm.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Template Releases | ${{ needs.release-templates.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Check what was released
        echo "## Releases Created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        RELEASES_CREATED=false

        # Check CLI release
        if [[ "${{ needs.detect-changes.outputs.cli }}" == "true" ]]; then
          CLI_TAG=$(git tag -l "v*" --sort=-version:refname | head -n 1 || echo "")
          if [[ -n "$CLI_TAG" ]]; then
            CLI_VERSION=${CLI_TAG#v}
            echo "### âœ… CLI (NuGet) - v$CLI_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Package:** \`pks-cli\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Version:** \`$CLI_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag:** \`$CLI_TAG\`" >> $GITHUB_STEP_SUMMARY
            echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/$CLI_TAG)" >> $GITHUB_STEP_SUMMARY
            echo "- [View on NuGet](https://www.nuget.org/packages/pks-cli/$CLI_VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            RELEASES_CREATED=true
          else
            echo "### âš ï¸ CLI" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Changes detected but no release created (no releasable commits)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        # Check npm release
        if [[ "${{ needs.detect-changes.outputs.cli }}" == "true" ]]; then
          NPM_TAG=$(git tag -l "npm-v*" --sort=-version:refname | head -n 1 || echo "")
          if [[ -n "$NPM_TAG" ]]; then
            NPM_VERSION=${NPM_TAG#npm-v}
            echo "### âœ… npm - v$NPM_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Package:** \`@pks-cli/pks\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Version:** \`$NPM_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag:** \`$NPM_TAG\`" >> $GITHUB_STEP_SUMMARY
            echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/$NPM_TAG)" >> $GITHUB_STEP_SUMMARY
            echo "- [View on npm](https://www.npmjs.com/package/@pks-cli/pks/v/$NPM_VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Platform Packages:**" >> $GITHUB_STEP_SUMMARY
            echo "- [@pks-cli/pks-linux-x64](https://www.npmjs.com/package/@pks-cli/pks-linux-x64/v/$NPM_VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "- [@pks-cli/pks-linux-arm64](https://www.npmjs.com/package/@pks-cli/pks-linux-arm64/v/$NPM_VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "- [@pks-cli/pks-osx-x64](https://www.npmjs.com/package/@pks-cli/pks-osx-x64/v/$NPM_VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "- [@pks-cli/pks-osx-arm64](https://www.npmjs.com/package/@pks-cli/pks-osx-arm64/v/$NPM_VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "- [@pks-cli/pks-win-x64](https://www.npmjs.com/package/@pks-cli/pks-win-x64/v/$NPM_VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "- [@pks-cli/pks-win-arm64](https://www.npmjs.com/package/@pks-cli/pks-win-arm64/v/$NPM_VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            RELEASES_CREATED=true
          fi
        fi

        # Check template releases
        for TEMPLATE in devcontainer claude-dotnet-9 claude-dotnet-10-full pks-fullstack; do
          # Check if this specific template has changes
          if [[ "${{ needs.detect-changes.outputs.devcontainer }}" == "true" && "$TEMPLATE" == "devcontainer" ]] || \
             [[ "${{ needs.detect-changes.outputs.claude-dotnet-9 }}" == "true" && "$TEMPLATE" == "claude-dotnet-9" ]] || \
             [[ "${{ needs.detect-changes.outputs.claude-dotnet-10-full }}" == "true" && "$TEMPLATE" == "claude-dotnet-10-full" ]] || \
             [[ "${{ needs.detect-changes.outputs.pks-fullstack }}" == "true" && "$TEMPLATE" == "pks-fullstack" ]]; then

            TEMPLATE_TAG=$(git tag -l "${TEMPLATE}-v*" --sort=-version:refname | head -n 1 || echo "")
            if [[ -n "$TEMPLATE_TAG" ]]; then
              TEMPLATE_VERSION=${TEMPLATE_TAG#${TEMPLATE}-v}

              # Map template name to package ID
              case "$TEMPLATE" in
                "devcontainer")
                  PACKAGE_ID="PKS.Templates.DevContainer"
                  ;;
                "claude-dotnet-9")
                  PACKAGE_ID="PKS.Templates.ClaudeDotNet9"
                  ;;
                "claude-dotnet-10-full")
                  PACKAGE_ID="PKS.Templates.ClaudeDotNet10.Full"
                  ;;
                "pks-fullstack")
                  PACKAGE_ID="PKS.Templates.PksFullstack"
                  ;;
              esac

              echo "### âœ… Template: $TEMPLATE - v$TEMPLATE_VERSION" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- **Package:** \`$PACKAGE_ID\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Version:** \`$TEMPLATE_VERSION\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Tag:** \`$TEMPLATE_TAG\`" >> $GITHUB_STEP_SUMMARY
              echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/$TEMPLATE_TAG)" >> $GITHUB_STEP_SUMMARY
              echo "- [View on NuGet](https://www.nuget.org/packages/$PACKAGE_ID/$TEMPLATE_VERSION)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              RELEASES_CREATED=true
            fi
          fi
        done

        if [[ "$RELEASES_CREATED" == "false" ]]; then
          echo "### â„¹ï¸ No Releases Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No new versions were released. This can happen when:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- No packages had changes since their last release" >> $GITHUB_STEP_SUMMARY
          echo "- Changes detected but no commits follow conventional commit format" >> $GITHUB_STEP_SUMMARY
          echo "- All commits use non-release types (\`chore:\`, \`docs:\`, \`style:\`)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Installation instructions
        if [[ "$RELEASES_CREATED" == "true" ]]; then
          echo "## ðŸ’» Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.detect-changes.outputs.cli }}" == "true" ]]; then
            CLI_TAG=$(git tag -l "v*" --sort=-version:refname | head -n 1 || echo "")
            NPM_TAG=$(git tag -l "npm-v*" --sort=-version:refname | head -n 1 || echo "")

            if [[ -n "$CLI_TAG" ]]; then
              CLI_VERSION=${CLI_TAG#v}
              echo "### CLI Tool (NuGet)" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
              if [[ "$CLI_VERSION" == *"-rc."* ]] || [[ "$CLI_VERSION" == *"-dev."* ]]; then
                echo "dotnet tool install --global pks-cli --version $CLI_VERSION --prerelease" >> $GITHUB_STEP_SUMMARY
              else
                echo "dotnet tool install --global pks-cli --version $CLI_VERSION" >> $GITHUB_STEP_SUMMARY
              fi
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            if [[ -n "$NPM_TAG" ]]; then
              NPM_VERSION=${NPM_TAG#npm-v}
              echo "### CLI Tool (npm)" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
              echo "# Global install" >> $GITHUB_STEP_SUMMARY
              echo "npm install -g @pks-cli/pks@$NPM_VERSION" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "# Or use with npx" >> $GITHUB_STEP_SUMMARY
              echo "npx @pks-cli/pks@$NPM_VERSION --version" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [[ "${{ needs.detect-changes.outputs.has-templates }}" == "true" ]]; then
            echo "### Templates" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY

            for TEMPLATE in devcontainer claude-dotnet-9 claude-dotnet-10-full pks-fullstack; do
              if [[ "${{ needs.detect-changes.outputs.devcontainer }}" == "true" && "$TEMPLATE" == "devcontainer" ]] || \
                 [[ "${{ needs.detect-changes.outputs.claude-dotnet-9 }}" == "true" && "$TEMPLATE" == "claude-dotnet-9" ]] || \
                 [[ "${{ needs.detect-changes.outputs.claude-dotnet-10-full }}" == "true" && "$TEMPLATE" == "claude-dotnet-10-full" ]] || \
                 [[ "${{ needs.detect-changes.outputs.pks-fullstack }}" == "true" && "$TEMPLATE" == "pks-fullstack" ]]; then

                TEMPLATE_TAG=$(git tag -l "${TEMPLATE}-v*" --sort=-version:refname | head -n 1 || echo "")
                if [[ -n "$TEMPLATE_TAG" ]]; then
                  TEMPLATE_VERSION=${TEMPLATE_TAG#${TEMPLATE}-v}

                  case "$TEMPLATE" in
                    "devcontainer")
                      PACKAGE_ID="PKS.Templates.DevContainer"
                      ;;
                    "claude-dotnet-9")
                      PACKAGE_ID="PKS.Templates.ClaudeDotNet9"
                      ;;
                    "claude-dotnet-10-full")
                      PACKAGE_ID="PKS.Templates.ClaudeDotNet10.Full"
                      ;;
                    "pks-fullstack")
                      PACKAGE_ID="PKS.Templates.PksFullstack"
                      ;;
                  esac

                  echo "# Install $TEMPLATE template" >> $GITHUB_STEP_SUMMARY
                  if [[ "$TEMPLATE_VERSION" == *"-rc."* ]] || [[ "$TEMPLATE_VERSION" == *"-dev."* ]]; then
                    echo "dotnet new install $PACKAGE_ID::$TEMPLATE_VERSION --force" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "dotnet new install $PACKAGE_ID::$TEMPLATE_VERSION" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo "" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done

            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        fi