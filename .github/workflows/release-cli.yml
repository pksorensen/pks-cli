name: Release CLI

on:
  workflow_call:

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  GIT_AUTHOR_NAME: "github-actions[bot]"
  GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"
  GIT_COMMITTER_NAME: "github-actions[bot]"
  GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"

jobs:
  release-cli:
    name: Release CLI Package
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          ~/.nuget/packages
        key: ${{ runner.os }}-cli-deps-${{ hashFiles('**/package-lock.json', 'src/pks-cli.csproj') }}
        restore-keys: |
          ${{ runner.os }}-cli-deps-

    - name: Install semantic-release
      run: |
        npm install -g \
          semantic-release \
          @semantic-release/changelog \
          @semantic-release/git \
          @semantic-release/github \
          @semantic-release/exec \
          conventional-changelog-conventionalcommits

    - name: Restore dependencies
      run: dotnet restore src/pks-cli.csproj

    - name: Build CLI project
      run: |
        echo "ðŸ”¨ Building PKS CLI..."
        dotnet build src/pks-cli.csproj --configuration Release --no-restore
        echo "âœ… Build completed successfully"

    - name: Run semantic-release
      id: semantic
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸš€ Running semantic release for CLI..."
        npx semantic-release --extends .releaserc.cli.json

    - name: Create NuGet package
      id: pack
      run: |
        # Get the latest tag (which semantic-release may have just created)
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

        if [ -n "$LATEST_TAG" ]; then
          # Remove 'v' prefix to get the version
          VERSION=${LATEST_TAG#v}
          echo "ðŸ“¦ Creating CLI package with version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "released=true" >> $GITHUB_OUTPUT

          # Create packages directory
          mkdir -p packages

          # Pack CLI project with the correct version
          dotnet pack src/pks-cli.csproj \
            --configuration Release \
            --output ./packages \
            --no-build \
            -p:PackageVersion=$VERSION

          echo "âœ… Package created successfully"
          ls -lh packages/
        else
          echo "â„¹ï¸ No release tag found, skipping package creation"
          echo "released=false" >> $GITHUB_OUTPUT
        fi

    - name: Publish to NuGet.org
      if: steps.pack.outputs.released == 'true'
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      run: |
        if [ -n "$NUGET_API_KEY" ]; then
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          VERSION=${{ steps.pack.outputs.version }}

          if [[ $VERSION == *"-rc."* ]] || [[ $VERSION == *"-dev."* ]]; then
            echo "ðŸ“¦ Publishing CLI PRE-RELEASE package (v$VERSION) to NuGet.org..."
          else
            echo "ðŸ“¦ Publishing CLI RELEASE package (v$VERSION) to NuGet.org..."
          fi

          for package in packages/*.nupkg; do
            if [ -f "$package" ]; then
              echo "Publishing $(basename $package)"
              dotnet nuget push "$package" \
                --api-key "$NUGET_API_KEY" \
                --source https://api.nuget.org/v3/index.json \
                --skip-duplicate || echo "âš ï¸ Failed to publish $package (may already exist)"
            fi
          done

          echo "âœ… NuGet publish completed"
        else
          echo "âš ï¸ NUGET_API_KEY not set, skipping NuGet publish"
        fi

    - name: Upload package as artifact
      if: steps.pack.outputs.released == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: cli-package-${{ steps.pack.outputs.version }}
        path: packages/*.nupkg
        retention-days: 30

    - name: Generate Release Summary
      if: always()
      run: |
        echo "# ðŸ“¦ CLI Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Check if a release was created
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

        if [ -n "$LATEST_TAG" ]; then
          VERSION=${LATEST_TAG#v}

          # Determine release type
          if [[ $VERSION == *"-rc."* ]] || [[ $VERSION == *"-dev."* ]]; then
            RELEASE_TYPE="Pre-release"
            EMOJI="ðŸ”¶"
          else
            RELEASE_TYPE="Stable Release"
            EMOJI="âœ…"
          fi

          echo "## $EMOJI CLI $RELEASE_TYPE Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List package created
          if [ -d "packages" ] && [ "$(ls -A packages/*.nupkg 2>/dev/null)" ]; then
            echo "### ðŸ“¦ Package Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for package in packages/*.nupkg; do
              if [ -f "$package" ]; then
                PACKAGE_NAME=$(basename "$package")
                PACKAGE_SIZE=$(ls -lh "$package" | awk '{print $5}')
                echo "- âœ… \`$PACKAGE_NAME\` ($PACKAGE_SIZE)" >> $GITHUB_STEP_SUMMARY
              fi
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Add links
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [View Release on GitHub](https://github.com/${{ github.repository }}/releases/tag/$LATEST_TAG)" >> $GITHUB_STEP_SUMMARY
          echo "- [View on NuGet.org](https://www.nuget.org/packages/pks-cli/$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Installation command
          echo "### ðŸ’» Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ $VERSION == *"-rc."* ]] || [[ $VERSION == *"-dev."* ]]; then
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "dotnet tool install --global pks-cli --version $VERSION --prerelease" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "dotnet tool install --global pks-cli --version $VERSION" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## â„¹ï¸ No CLI Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No new version was released for the CLI package." >> $GITHUB_STEP_SUMMARY
        fi
